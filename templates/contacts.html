{% extends "base.html" %}
{% block title %}Contacts - Contact Mailer{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Contacts <span class="count">({{ contacts|length }})</span></h1>
    <a href="{{ url_for('contact_new') }}" class="btn btn-primary">+ Nouveau contact</a>
</div>

<div class="filters">
    <form method="GET" class="filter-form">
        <input type="text" name="q" value="{{ search }}" placeholder="Rechercher..." class="search-input">
        <select name="liste" onchange="this.form.submit()">
            <option value="">Toutes les listes</option>
            {% for liste in listes %}
            <option value="{{ liste.id }}" {% if liste.id == liste_filter %}selected{% endif %}>
                {{ liste.nom }} ({{ liste.count }})
            </option>
            {% endfor %}
        </select>
        <button type="submit" class="btn">Filtrer</button>
        {% if search or liste_filter %}
        <a href="{{ url_for('contacts') }}" class="btn btn-secondary">Effacer</a>
        {% endif %}
    </form>
</div>

<form method="POST" action="{{ url_for('contacts_bulk_action') }}" id="bulk-form">
    <div class="bulk-actions">
        <label class="select-all-label">
            <input type="checkbox" id="select-all"> Tout sélectionner
        </label>
        <select name="liste_id" class="bulk-liste-select">
            <option value="">-- Choisir une liste --</option>
            {% for liste in listes %}
            <option value="{{ liste.id }}">{{ liste.nom }}</option>
            {% endfor %}
        </select>
        <button type="submit" name="action" value="add_to_liste" class="btn btn-small">Ajouter à la liste</button>
        <button type="submit" name="action" value="remove_from_liste" class="btn btn-small">Retirer de la liste</button>
        <button type="submit" name="action" value="delete" class="btn btn-danger btn-small"
                onclick="return confirm('Supprimer les contacts sélectionnés ?')">Supprimer</button>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th class="col-checkbox"></th>
                <th>Nom</th>
                <th>Email</th>
                <th>Téléphone</th>
                <th>Organisation</th>
                <th>Listes</th>
                <th class="col-actions">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for contact in contacts %}
            <tr>
                <td><input type="checkbox" name="contact_ids" value="{{ contact.id }}" class="contact-checkbox"></td>
                <td><strong>{{ contact.nom }}</strong> {{ contact.prenom }}</td>
                <td><a href="mailto:{{ contact.email }}">{{ contact.email }}</a></td>
                <td>{{ contact.telephone or '-' }}</td>
                <td>{{ contact.organisation or '-' }}</td>
                <td>
                    {% for liste in contact.listes %}
                    <span class="tag">{{ liste.nom }}</span>
                    {% endfor %}
                </td>
                <td class="actions">
                    <a href="{{ url_for('contact_edit', id=contact.id) }}" class="btn btn-small">Modifier</a>
                    <form method="POST" action="{{ url_for('contact_delete', id=contact.id) }}" style="display:inline">
                        <button type="submit" class="btn btn-danger btn-small"
                                onclick="return confirm('Supprimer ce contact ?')">Suppr.</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="empty">Aucun contact trouvé</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</form>

{% if liste_filter %}
<div class="export-section">
    <a href="{{ url_for('export_contacts', liste=liste_filter) }}" class="btn">Exporter cette liste (TSV)</a>
</div>
{% else %}
<div class="export-section">
    <a href="{{ url_for('export_contacts') }}" class="btn">Exporter tous les contacts (TSV)</a>
</div>
{% endif %}

<script>
document.getElementById('select-all').addEventListener('change', function() {
    document.querySelectorAll('.contact-checkbox').forEach(cb => cb.checked = this.checked);
});
</script>
{% endblock %}
