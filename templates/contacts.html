{% extends "base.html" %}
{% block title %}Contacts - Contact Mailer{% endblock %}
{% block container_class %}container-wide{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Contacts <span class="count">({{ contacts|length }})</span></h1>
    <a href="{{ url_for('contact_new') }}" class="btn btn-primary">+ Nouveau contact</a>
</div>

<div class="filters">
    <form method="GET" class="filter-form">
        <input type="text" name="q" value="{{ search }}" placeholder="Rechercher..." class="search-input">
        <select name="liste" onchange="this.form.submit()">
            <option value="">Toutes les listes</option>
            {% for liste in listes %}
            <option value="{{ liste.id }}" {% if liste.id == liste_filter %}selected{% endif %}>
                {{ liste.nom }} ({{ liste.count }})
            </option>
            {% endfor %}
        </select>
        <select name="source" onchange="this.form.submit()">
            <option value="">Toutes les sources</option>
            {% for src in sources %}
            <option value="{{ src }}" {% if src == source_filter %}selected{% endif %}>{{ src }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn">Filtrer</button>
        {% if search or liste_filter or source_filter %}
        <a href="{{ url_for('contacts') }}" class="btn btn-secondary">Effacer</a>
        {% endif %}
    </form>
</div>

<form method="POST" action="{{ url_for('contacts_bulk_action') }}" id="bulk-form">
    <div class="bulk-actions">
        <label class="select-all-label">
            <input type="checkbox" id="select-all"> Tout s√©lectionner
        </label>
        <select name="liste_id" class="bulk-liste-select">
            <option value="">-- Choisir une liste --</option>
            {% for liste in listes %}
            <option value="{{ liste.id }}">{{ liste.nom }}</option>
            {% endfor %}
        </select>
        <button type="submit" name="action" value="add_to_liste" class="btn btn-small">Ajouter √† la liste</button>
        <button type="submit" name="action" value="remove_from_liste" class="btn btn-small">Retirer de la liste</button>
        <button type="submit" name="action" value="delete" class="btn btn-danger btn-small"
                onclick="return confirm('Supprimer les contacts s√©lectionn√©s ?')">Supprimer</button>
    </div>

    <table class="data-table data-table-contacts">
        <thead>
            <tr>
                <th class="col-checkbox"></th>
                <th>Nom</th>
                <th>Email</th>
                <th>T√©l√©phone</th>
                <th>Organisation</th>
                <th>Listes</th>
                <th class="col-actions">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for contact in contacts %}
            <tr>
                <td><input type="checkbox" name="contact_ids" value="{{ contact.id }}" class="contact-checkbox"></td>
                <td>
                    <strong>{{ contact.nom }}</strong> {{ contact.prenom }}
                    {% if contact.is_unsubscribed %}<span class="tag tag-unsub">D√©sabonn√©</span>{% endif %}
                </td>
                <td><a href="mailto:{{ contact.email }}">{{ contact.email }}</a></td>
                <td>{% if contact.telephone %}<a href="tel:{{ contact.telephone }}" class="tel-link">{{ contact.telephone }}</a>{% else %}-{% endif %}</td>
                <td>{{ contact.organisation or '-' }}</td>
                <td>
                    {% for liste in contact.listes %}
                    <span class="tag">{{ liste.nom }}</span>
                    {% endfor %}
                </td>
                <td class="actions">
                    <a href="{{ url_for('contact_edit', id=contact.id, back_liste=liste_filter or '') }}" class="btn btn-small">Modifier</a>
                    <form method="POST" action="{{ url_for('contact_delete', id=contact.id) }}" style="display:inline">
                        <button type="submit" class="btn btn-danger btn-small"
                                onclick="return confirm('Supprimer ce contact ?')">Suppr.</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="empty">Aucun contact trouv√©</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

<!-- Vue cards pour mobile -->
<div class="mobile-cards">
    {% for contact in contacts %}
    <div class="contact-card">
        <div class="contact-card-header">
            <label class="contact-card-check">
                <input type="checkbox" name="contact_ids" value="{{ contact.id }}" class="contact-checkbox">
            </label>
            <div>
                <div class="contact-card-name">
                    {{ contact.nom }} {{ contact.prenom }}
                    {% if contact.is_unsubscribed %}<span class="tag tag-unsub">D√©sabonn√©</span>{% endif %}
                </div>
                {% if contact.organisation %}<div style="font-size:0.8rem;color:var(--gray-500);">{{ contact.organisation }}</div>{% endif %}
            </div>
            <div class="contact-card-actions">
                <a href="{{ url_for('contact_edit', id=contact.id, back_liste=liste_filter or '') }}" class="btn btn-small">Modifier</a>
                <form method="POST" action="{{ url_for('contact_delete', id=contact.id) }}" style="display:inline">
                    <button type="submit" class="btn btn-danger btn-small"
                            onclick="return confirm('Supprimer ce contact ?')">Suppr.</button>
                </form>
            </div>
        </div>
        <div class="contact-card-body">
            {% if contact.email %}<a href="mailto:{{ contact.email }}">{{ contact.email }}</a>{% endif %}
            {% if contact.telephone %}<a href="tel:{{ contact.telephone }}">üìû {{ contact.telephone }}</a>{% endif %}
            <div>{% for liste in contact.listes %}<span class="tag">{{ liste.nom }}</span>{% endfor %}</div>
        </div>
    </div>
    {% else %}
    <p class="empty">Aucun contact trouv√©</p>
    {% endfor %}
</div>
</form>

{% if liste_filter %}
<div class="export-section">
    <a href="{{ url_for('export_contacts', liste=liste_filter) }}" class="btn">Exporter cette liste (TSV)</a>
</div>
{% else %}
<div class="export-section">
    <a href="{{ url_for('export_contacts') }}" class="btn">Exporter tous les contacts (TSV)</a>
</div>
{% endif %}

<script>
document.getElementById('select-all').addEventListener('change', function() {
    document.querySelectorAll('.contact-checkbox').forEach(cb => {
        if (cb.offsetParent !== null) cb.checked = this.checked;
    });
});
</script>

<style>
.tag-unsub {
    background: #fee2e2;
    color: #991b1b;
    font-size: 0.7rem;
    padding: 0.1rem 0.4rem;
    border-radius: 99px;
    font-weight: 600;
    margin-left: 0.25rem;
}
</style>
{% endblock %}
