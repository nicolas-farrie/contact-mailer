{% extends "base.html" %}
{% block title %}{{ 'Modifier' if contact else 'Nouveau' }} contact - Contact Mailer{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ 'Modifier le contact' if contact else 'Nouveau contact' }}</h1>
</div>

<form method="POST" class="form-card">
    <input type="hidden" name="back_liste" value="{{ back_liste or '' }}">
    {% if contact %}
    <div class="form-row">
        <div class="form-group">
            <label for="uid">UID</label>
            <input type="text" id="uid" value="{{ contact.uid }}" readonly disabled
                   style="font-family: monospace; font-size: 0.8rem; color: var(--gray-500); background: var(--gray-100);">
        </div>
        <div class="form-group">
            <label for="source">Source</label>
            <input type="text" id="source" value="{{ contact.source or '' }}" readonly disabled
                   style="color: var(--gray-500); background: var(--gray-100);">
        </div>
    </div>
    <div class="form-row">
        <div class="form-group">
            <label>Créé par</label>
            <input type="text" value="{{ contact.created_by.display_name if contact.created_by else '-' }}" readonly disabled
                   style="color: var(--gray-500); background: var(--gray-100);">
        </div>
        <div class="form-group">
            <label>Modifié par</label>
            <input type="text" value="{{ contact.updated_by.display_name if contact.updated_by else '-' }}" readonly disabled
                   style="color: var(--gray-500); background: var(--gray-100);">
        </div>
    </div>
    {% if contact.is_unsubscribed %}
    <div class="unsub-banner">
        <span class="unsub-status">Désabonné le {{ contact.unsubscribed_at.strftime('%d/%m/%Y') if contact.unsubscribed_at else '?' }}</span>
        <form method="POST" action="{{ url_for('contact_resubscribe', id=contact.id) }}" style="display:inline">
            <button type="submit" class="btn btn-small" onclick="return confirm('Réabonner ce contact ?')">Réabonner</button>
        </form>
    </div>
    {% endif %}
    {% endif %}

    <div class="form-row">
        <div class="form-group">
            <label for="nom">Nom *</label>
            <input type="text" id="nom" name="nom" value="{{ contact.nom if contact else '' }}" required>
        </div>
        <div class="form-group">
            <label for="prenom">Prénom *</label>
            <input type="text" id="prenom" name="prenom" value="{{ contact.prenom if contact else '' }}" required>
        </div>
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="email">Email *</label>
            <input type="email" id="email" name="email" value="{{ contact.email if contact else '' }}" required>
        </div>
        <div class="form-group">
            <label for="telephone">Téléphone</label>
            <input type="tel" id="telephone" name="telephone" value="{{ contact.telephone if contact else '' }}">
        </div>
    </div>

    <div class="form-group">
        <label for="organisation">Organisation</label>
        <input type="text" id="organisation" name="organisation" value="{{ contact.organisation if contact else '' }}">
    </div>

    <fieldset class="form-fieldset">
        <legend>Adresse</legend>
        <div class="form-group">
            <label for="adresse_rue">Rue</label>
            <input type="text" id="adresse_rue" name="adresse_rue" value="{{ contact.adresse_rue if contact else '' }}"
                   placeholder="12, rue de la Paix">
        </div>
        <div class="form-group">
            <label for="adresse_complement">Complément</label>
            <input type="text" id="adresse_complement" name="adresse_complement" value="{{ contact.adresse_complement if contact else '' }}"
                   placeholder="Bât. B, Appt 42">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="adresse_cp">Code postal</label>
                <input type="text" id="adresse_cp" name="adresse_cp" value="{{ contact.adresse_cp if contact else '' }}"
                       placeholder="34000" style="max-width: 8rem;">
            </div>
            <div class="form-group">
                <label for="adresse_ville">Ville</label>
                <input type="text" id="adresse_ville" name="adresse_ville" value="{{ contact.adresse_ville if contact else '' }}"
                       placeholder="Montpellier">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="adresse_region">Région</label>
                <input type="text" id="adresse_region" name="adresse_region" value="{{ contact.adresse_region if contact else '' }}">
            </div>
            <div class="form-group">
                <label for="adresse_pays">Pays</label>
                <input type="text" id="adresse_pays" name="adresse_pays" value="{{ contact.adresse_pays if contact else '' }}"
                       placeholder="France">
            </div>
        </div>
    </fieldset>

    <div class="form-group">
        <label for="notes">Notes</label>
        <textarea id="notes" name="notes" rows="3">{{ contact.notes if contact else '' }}</textarea>
    </div>

    <div class="form-group">
        <label>Listes</label>
        <div class="checkbox-group">
            {% for liste in listes %}
            <label class="checkbox-label">
                <input type="checkbox" name="listes" value="{{ liste.id }}"
                       {% if contact and liste in contact.listes %}checked{% endif %}>
                {{ liste.nom }}
            </label>
            {% endfor %}
        </div>
        {% if not listes %}
        <p class="hint">Aucune liste créée. <a href="{{ url_for('liste_new') }}">Créer une liste</a></p>
        {% endif %}
    </div>

    <div class="form-actions">
        <button type="submit" class="btn {% if contact %}btn-warning{% else %}btn-primary{% endif %}">{{ 'Modifier' if contact else 'Créer' }}</button>
        <a href="{{ url_for('contacts', liste=back_liste) if back_liste else url_for('contacts') }}" class="btn btn-secondary">Annuler</a>
    </div>
</form>

<style>
.unsub-banner {
    background: #fee2e2;
    border: 1px solid #fecaca;
    color: #991b1b;
    padding: 0.75rem 1rem;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
}
.unsub-status {
    font-weight: 600;
}
</style>
{% endblock %}
