{% extends "base.html" %}
{% block title %}Mailing - Contact Mailer{% endblock %}
{% block container_class %}container-wide{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.snow.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.js"></script>

<div class="page-header">
    <h1>Nouveau mailing</h1>
    <div>
        <a href="{{ url_for('mailing_history') }}" class="btn">Historique</a>
        <a href="{{ url_for('mailing_queue') }}" class="btn">File d'attente</a>
    </div>
</div>

{% if not smtp_configured %}
<div class="alert alert-error">
    <strong>SMTP non configuré.</strong> Ajoutez les variables SMTP_HOST, SMTP_USER, etc. dans votre fichier .env
</div>
{% endif %}

<div class="mailing-container">
    <form method="POST" action="{{ url_for('mailing_send') }}" class="form-card mailing-form" id="mailing-form">
        <div class="form-group">
            <label for="liste_id">Liste de destinataires *</label>
            <select id="liste_id" name="liste_id" required>
                <option value="">-- Sélectionner une liste --</option>
                {% for liste in listes %}
                <option value="{{ liste.id }}">{{ liste.nom }} ({{ liste.count }} contacts)</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="subject">Sujet *</label>
            <input type="text" id="subject" name="subject" required
                   value="{{ prefill.subject }}"
                   placeholder="Ex: Invitation à notre réunion du {prenom}">
            <p class="hint">Variables disponibles : {prenom}, {nom}, {email}, {organisation}, {uid}</p>
        </div>

        <div class="form-group">
            <label>Format</label>
            <div class="format-toggle">
                <label class="checkbox-label">
                    <input type="radio" name="format" value="text" {{ 'checked' if prefill.format == 'text' and prefill.subject }} onchange="toggleFormat()"> Texte brut
                </label>
                <label class="checkbox-label">
                    <input type="radio" name="format" value="html" {{ 'checked' if prefill.format != 'text' or not prefill.subject }} onchange="toggleFormat()"> HTML
                </label>
            </div>
        </div>

        <div class="form-group">
            <label>Message *</label>
            <!-- Textarea pour le mode texte -->
            <textarea id="body" name="body" rows="12"
                      placeholder="Bonjour {prenom},&#10;&#10;Nous vous invitons à...&#10;&#10;Cordialement,&#10;L'équipe"
                      >{{ prefill.body }}</textarea>
            <!-- Editeur Quill pour le mode HTML -->
            <div id="editor-container" style="display:none;">
                <div id="editor"></div>
            </div>
            <p class="hint">Variables : {prenom}, {nom}, {email}, {organisation}, {telephone}, {uid}</p>
        </div>

        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" name="include_unsubscribe" checked>
                Inclure un lien de désabonnement (recommandé)
            </label>
            <p class="hint">Ajoute un lien de désabonnement en bas de chaque email et le header List-Unsubscribe.</p>
        </div>

        <div class="form-actions">
            <button type="button" class="btn" id="preview-btn" onclick="togglePreview()">Prévisualiser</button>
            <button type="submit" class="btn btn-primary" {% if not smtp_configured %}disabled{% endif %}>
                Préparer l'envoi
            </button>
        </div>
    </form>

    <div class="preview-panel" id="preview-panel" style="display:none;">
        <h3>Prévisualisation</h3>
        <p class="hint" id="preview-contact"></p>
        <div class="preview-subject" id="preview-subject"></div>
        <div class="preview-body" id="preview-body"></div>
    </div>
</div>

<div class="info-box">
    <h3>Variables de personnalisation</h3>
    <p>Utilisez ces variables dans le sujet et le message, elles seront remplacées pour chaque contact :</p>
    <ul>
        <li><code>{prenom}</code> - Prénom du contact</li>
        <li><code>{nom}</code> - Nom du contact</li>
        <li><code>{email}</code> - Adresse email</li>
        <li><code>{organisation}</code> - Organisation</li>
        <li><code>{telephone}</code> - Téléphone</li>
        <li><code>{adresse_rue}</code>, <code>{adresse_complement}</code>, <code>{adresse_ville}</code>, <code>{adresse_cp}</code>, <code>{adresse_region}</code>, <code>{adresse_pays}</code> - Adresse</li>
        <li><code>{uid}</code> - Identifiant unique du contact</li>
    </ul>
</div>

<script>
// === Quill ===
const quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
        toolbar: [
            [{ header: [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            ['link'],
            [{ list: 'ordered' }, { list: 'bullet' }],
            ['blockquote'],
            [{ color: [] }],
            ['clean']
        ]
    },
    placeholder: 'Rédigez votre message HTML...'
});

const bodyTextarea = document.getElementById('body');
const editorContainer = document.getElementById('editor-container');
const DRAFT_KEY = 'mailing_draft';

function isHtmlMode() {
    return document.querySelector('input[name="format"][value="html"]').checked;
}

function toggleFormat() {
    if (isHtmlMode()) {
        const text = bodyTextarea.value;
        if (text && quill.getText().trim() === '') {
            const html = text.split('\n').map(l => '<p>' + (l || '<br>') + '</p>').join('');
            quill.root.innerHTML = html;
        }
        bodyTextarea.style.display = 'none';
        editorContainer.style.display = 'block';
    } else {
        const quillText = quill.getText().trim();
        if (quillText && !bodyTextarea.value.trim()) {
            bodyTextarea.value = quillText;
        }
        editorContainer.style.display = 'none';
        bodyTextarea.style.display = 'block';
    }
    saveDraft();
}

// Sync Quill → textarea au submit
document.getElementById('mailing-form').addEventListener('submit', function() {
    if (isHtmlMode()) {
        bodyTextarea.value = quill.root.innerHTML;
    }
    // Effacer le brouillon après envoi
    localStorage.removeItem(DRAFT_KEY);
});

// Sync Quill → textarea pour la preview aussi
function syncBody() {
    if (isHtmlMode()) {
        bodyTextarea.value = quill.root.innerHTML;
    }
}

// === Brouillon (localStorage) ===
function saveDraft() {
    const draft = {
        liste_id: document.getElementById('liste_id').value,
        subject: document.getElementById('subject').value,
        format: isHtmlMode() ? 'html' : 'text',
        body_text: bodyTextarea.value,
        body_html: quill.root.innerHTML,
        include_unsubscribe: document.querySelector('input[name="include_unsubscribe"]').checked
    };
    localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
}

function restoreDraft() {
    const raw = localStorage.getItem(DRAFT_KEY);
    if (!raw) return false;
    try {
        const draft = JSON.parse(raw);
        if (draft.liste_id) document.getElementById('liste_id').value = draft.liste_id;
        if (draft.subject) document.getElementById('subject').value = draft.subject;
        if (draft.format) {
            document.querySelector(`input[name="format"][value="${draft.format}"]`).checked = true;
        }
        if (draft.format === 'html' && draft.body_html) {
            quill.root.innerHTML = draft.body_html;
            bodyTextarea.value = draft.body_html;
        } else if (draft.body_text) {
            bodyTextarea.value = draft.body_text;
        }
        if (draft.include_unsubscribe !== undefined) {
            document.querySelector('input[name="include_unsubscribe"]').checked = draft.include_unsubscribe;
        }
        return true;
    } catch(e) {
        return false;
    }
}

// Sauvegarder régulièrement
document.getElementById('subject').addEventListener('input', saveDraft);
bodyTextarea.addEventListener('input', saveDraft);
quill.on('text-change', saveDraft);
document.getElementById('liste_id').addEventListener('change', saveDraft);
document.querySelector('input[name="include_unsubscribe"]').addEventListener('change', saveDraft);

// === Init ===
// Restaurer le brouillon seulement si pas de prefill (réutilisation)
const hasPrefill = {{ 'true' if prefill.subject else 'false' }};
if (!hasPrefill) {
    restoreDraft();
}

// Afficher le bon éditeur selon le mode
if (isHtmlMode()) {
    const currentBody = bodyTextarea.value;
    bodyTextarea.style.display = 'none';
    editorContainer.style.display = 'block';
    if (currentBody && quill.getText().trim() === '') {
        quill.root.innerHTML = currentBody;
    }
}

// === Preview ===
let previewVisible = false;

function togglePreview() {
    const panel = document.getElementById('preview-panel');
    const btn = document.getElementById('preview-btn');
    const container = document.querySelector('.mailing-container');

    if (previewVisible) {
        // Masquer
        panel.style.display = 'none';
        container.classList.remove('with-preview');
        btn.textContent = 'Prévisualiser';
        btn.classList.remove('btn-preview-active');
        previewVisible = false;
        return;
    }

    // Charger et afficher
    syncBody();
    const form = document.getElementById('mailing-form');
    const formData = new FormData(form);

    fetch('{{ url_for("mailing_preview") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }
        document.getElementById('preview-contact').textContent = 'Aperçu pour : ' + data.contact;
        document.getElementById('preview-subject').textContent = data.subject;

        const previewBody = document.getElementById('preview-body');
        if (isHtmlMode()) {
            previewBody.innerHTML = data.body;
        } else {
            previewBody.textContent = data.body;
        }
        panel.style.display = 'block';
        container.classList.add('with-preview');
        btn.textContent = 'Masquer';
        btn.classList.add('btn-preview-active');
        previewVisible = true;
    })
    .catch(err => alert('Erreur : ' + err));
}
</script>

<style>
.mailing-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    align-items: start;
}
.mailing-container.with-preview {
    grid-template-columns: 1fr 1fr;
}
.mailing-form {
    max-width: none;
}
.preview-panel {
    background: white;
    padding: 1.5rem;
    border-radius: var(--radius);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.preview-panel h3 {
    margin-bottom: 0.5rem;
}
.preview-subject {
    font-weight: bold;
    padding: 0.5rem;
    background: var(--gray-100);
    border-radius: var(--radius);
    margin: 0.5rem 0;
}
.preview-body {
    white-space: pre-wrap;
    padding: 0.75rem;
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    font-family: inherit;
    min-height: 200px;
}
/* Quill editor */
#editor-container {
    border-radius: var(--radius);
}
#editor {
    min-height: 250px;
    background: white;
}
#editor .ql-editor {
    font-family: inherit;
    font-size: 0.95rem;
}
.btn-preview-active {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}
.btn-preview-active:hover {
    background: var(--primary-dark);
}
@media (max-width: 900px) {
    .mailing-container {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
